apiVersion: batch/v1
kind: Job
metadata:
  name: stock-batch-manual
  namespace: trendscope-stock-batch
  labels:
    app: trendscope-stock-db-batch
    job-type: manual-run
spec:
  backoffLimit: 2
  activeDeadlineSeconds: 3600  # 1時間でタイムアウト
  ttlSecondsAfterFinished: 86400  # 完了後24時間で自動削除
  template:
    metadata:
      labels:
        app: trendscope-stock-db-batch
        job-type: manual-run
    spec:
      restartPolicy: Never
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
      - name: stock-batch
        image: trendscope/stock-db-batch:v1.0.0
        imagePullPolicy: Always
        
        # セキュリティコンテキスト
        securityContext:
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
        
        # リソース制限
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        
        # 環境変数
        envFrom:
        - configMapRef:
            name: stock-batch-config
        - secretRef:
            name: stock-batch-secrets
            optional: true
        
        # ボリュームマウント
        volumeMounts:
        - name: data-volume
          mountPath: /data
        
        # コマンド
        command: ["/usr/local/bin/python"]
        args: ["-m", "stock_batch.main"]
        
        # 環境変数の個別設定
        env:
        - name: PYTHONPATH
          value: "/app/src"
        - name: PYTHONUNBUFFERED
          value: "1"
        
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: stock-batch-data
---